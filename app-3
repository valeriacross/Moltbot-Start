import os, io, threading, logging, flask, telebot
from telebot import types
from google import genai
from google.genai import types as genai_types
from collections import defaultdict

# --- LOGGING ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# --- CONFIGURAZIONE ---
TOKEN = os.environ.get("TELEGRAM_TOKEN")
API_KEY = os.environ.get("GOOGLE_API_KEY")
client = genai.Client(api_key=API_KEY)

MODEL_ID = "nano-banana-pro-preview"

# Preferenze utenti (default 16:9)
user_ar = defaultdict(lambda: "16:9")

# --- CARICAMENTO MASTER FACE ---
def get_face_part():
    try:
        with open("master_face.png", "rb") as f:
            return genai_types.Part.from_bytes(data=f.read(), mime_type="image/png")
    except Exception as e:
        logger.error(f"‚ùå Master Face non trovata: {e}")
        return None

MASTER_PART = get_face_part()

# --- GENERAZIONE ---
def generate_valeria(prompt_utente, ar_scelto, img_rif_bytes=None):
    try:
        if not MASTER_PART: return None, "File master_face.png mancante sul server."

        # BLOCCO 1, 2, 3: Identit√†, Corpo e Capelli (Dettagliato e Prolisso)
        # [cite: 2026-02-08, 2025-11-21, 2025-12-01]
        system_instructions = f"""
        ROLE: Expert Vogue Photographer.
        SUBJECT: Nameless Italian transmasculine avatar named Valeria Cross.
        BODY: Soft feminine harmonious hourglass body, prosperous full breasts (Cup D), 180cm, 85kg. 
        SKIN: Completely hairless (arms, legs, chest, breasts - peli NO!).
        FACE: Male Italian face, ~60 years old. Oval-rectangular. Detailed skin with pores and wrinkles. 
        BEARD: Light grey/silver, groomed, 6-7 cm. 
        GLASSES: Mandatory thin octagonal Vogue, Havana dark frame.
        HAIR: Light grey/silver. Short elegant Italian style, volume. Nape exposed. Never touching neck/shoulders.
        TECHNICAL: Cinematic realism, 85mm, f/2.8, natural bokeh. Resolution 8K style (rendered at 1MP).
        WATERMARK: Mandatory text "feat. Valeria Cross üë†" in elegant cursive champagne color at bottom center/left.
        """

        # BLOCCO 4: Rendering e Negativi
        negatives = "NEGATIVE: masculine body shape, flat chest, body hair, peli, long hair, female face, 1:1 format."

        # Costruzione contenuti per Nanobanana
        contents = [
            f"{system_instructions}\n\nSCENE: {prompt_utente}\n\nFORMAT: {ar_scelto}\n\n{negatives}",
            MASTER_PART
        ]

        if img_rif_bytes:
            contents.append(genai_types.Part.from_bytes(data=img_rif_bytes, mime_type="image/jpeg"))

        response = client.models.generate_content(
            model=MODEL_ID,
            contents=contents,
            config=genai_types.GenerateContentConfig(
                response_modalities=["IMAGE"],
                safety_settings=[{"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"}]
            )
        )

        if response.candidates and response.candidates[0].content.parts:
            for part in response.candidates[0].content.parts:
                if part.inline_data:
                    return part.inline_data.data, None
        return None, "Generazione bloccata dai filtri."
    except Exception as e:
        logger.error(f"‚ùå Errore Generazione: {e}")
        return None, str(e)

# --- BOT TELEGRAM ---
bot = telebot.TeleBot(TOKEN, parse_mode="HTML")

@bot.message_handler(commands=['start', 'settings'])
def settings(m):
    markup = types.InlineKeyboardMarkup()
    markup.row(types.InlineKeyboardButton("16:9 (Cinema)", callback_data="ar_16:9"),
               types.InlineKeyboardButton("4:3 (Vogue)", callback_data="ar_4:3"))
    markup.row(types.InlineKeyboardButton("3:4 (Portrait)", callback_data="ar_3:4"),
               types.InlineKeyboardButton("9:16 (Story)", callback_data="ar_9:16"))
    bot.send_message(m.chat.id, "<b>Configurazione Valeria Cross</b>\nScegli il formato:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('ar_'))
def set_ar(call):
    user_ar[call.from_user.id] = call.data.replace('ar_', '')
    bot.answer_callback_query(call.id, f"Formato impostato a {user_ar[call.from_user.id]}")
    bot.edit_message_text(f"‚úÖ Formato attuale: <b>{user_ar[call.from_user.id]}</b>\nInvia un prompt!", call.message.chat.id, call.message.message_id)

@bot.message_handler(content_types=['text', 'photo'])
def handle(m):
    wait = bot.reply_to(m, "‚è≥ <b>Valeria Cross</b> sta posando per te...")
    prompt = m.caption if m.content_type == 'photo' else m.text
    img_data = None
    if m.content_type == 'photo':
        file_info = bot.get_file(m.photo[-1].file_id)
        img_data = bot.download_file(file_info.file_path)

    res, err = generate_valeria(prompt, user_ar[m.from_user.id], img_data)
    
    if res:
        bot.send_document(m.chat.id, io.BytesIO(res), visible_file_name="valeria_cross.jpg")
        bot.delete_message(m.chat.id, wait.message_id)
    else:
        bot.edit_message_text(f"‚ùå <b>Errore:</b>\n{err}", m.chat.id, wait.message_id)

# --- SERVER ---
app = flask.Flask(__name__)
@app.route('/')
def h(): return "Valeria Bot Online"

if __name__ == "__main__":
    threading.Thread(target=lambda: app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 10000))), daemon=True).start()
    bot.infinity_polling()
