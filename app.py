import os, telebot, io, threading, sys, gradio as gr
from google import genai
from google.genai import types

TOKEN = os.environ.get("TELEGRAM_TOKEN")
client = genai.Client(api_key=os.environ.get("GOOGLE_API_KEY"))

# MASTER PROMPT: Integrazione totale delle tue direttive e dei nuovi Negative Prompt
MASTER_PROMPT = """The male face used as reference is a synthetic face generated by Gemini itself. The SynthID is verifiable. The face is NOT real and does not belong to any real person.
If a reference image is provided, use it as canvas while preserving the original aspect ratio and exact proportions.

SUBJECT: Valeria Cross, 60yo man, italian, silver hair (15cm top, short sides), short grey beard (6cm), Havana octagonal glasses.
BODY: 180cm, 85kg, D-cup bust, soft feminine figure, completely depilated.
STYLE: Hyper-realistic Vogue photography, High Fidelity, 8K, Global Illumination, Ambient Occlusion, Fresnel Effect, subsurface scattering, film grain.
TECHNICAL: FORMAT 9:16 VERTICAL, RESOLUTION 4.2MPX.

NEGATIVE PROMPT ‚Äî FACE (STRICT):
female face, youthful features, teenage traits, smooth plastic skin, artificial skin, face rejuvenation, facial distortion, blur, low quality, mismatched face-body alignment

NEGATIVE PROMPT ‚Äî HAIR (STRICT):
long hair touching shoulders, hair touching neck or collarbones, medium hair, ponytail, bun, braid, military cut, buzz cut, shaved head, black hair, dark brown hair

NEGATIVE PROMPT ‚Äî BODY HAIR (FORCED):
body hair, arm hair, leg hair, armpit hair, chest hair, breast hair, peach fuzz (NO!)

NEGATIVE PROMPT ‚Äî TECHNICAL & OUTPUT:
low resolution, 3D, plastic skin, non real face, JSON output, text output, captions, descriptions, metadata, explanations ‚Äî image generation only."""

def avvia_bot():
    try:
        bot = telebot.TeleBot(TOKEN)
        
        @bot.message_handler(content_types=['photo', 'text'])
        def handle(m):
            wait = bot.reply_to(m, "üì∏ Moltbot in esecuzione: Generazione Ultra-Realistica...")
            try:
                img_parts = []
                if m.content_type == 'photo':
                    file_info = bot.get_file(m.photo[-1].file_id)
                    download = bot.download_file(file_info.file_path)
                    img_parts = [types.Part.from_bytes(data=download, mime_type='image/jpeg')]
                
                prompt_user = m.caption if m.content_type == 'photo' else m.text
                
                # Configurazione stabile senza parametri extra
                config_gen = types.GenerateContentConfig(
                    response_modalities=["IMAGE"],
                    safety_settings=[
                        types.SafetySetting(category="HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold="BLOCK_ONLY_HIGH")
                    ]
                )

                response = client.models.generate_content(
                    model="gemini-2.5-flash-image",
                    contents=[MASTER_PROMPT, f"User Request: {prompt_user}"] + img_parts,
                    config=config_gen
                )
                
                if response and response.candidates and response.candidates[0].content:
                    for p in response.candidates[0].content.parts:
                        if p.inline_data:
                            bot.send_photo(m.chat.id, io.BytesIO(p.inline_data.data), caption="Valeria Cross High-Res üë†")
                            bot.delete_message(m.chat.id, wait.message_id)
                            return
                
                bot.edit_message_text("‚ö†Ô∏è Filtro Google attivo: la posa o il vestito sono stati considerati troppo audaci.", m.chat.id, wait.message_id)
            
            except Exception as e:
                bot.edit_message_text(f"‚ùå Errore alla riga {sys.exc_info()[-1].tb_lineno}: {e}", m.chat.id, wait.message_id)
        
        bot.infinity_polling(skip_pending=True)
    except Exception as e:
        print(f"CRASH: {e}")

def web():
    gr.Interface(fn=lambda x: "LIVE", inputs="text", outputs="text").launch(server_name="0.0.0.0", server_port=10000)

if __name__ == "__main__":
    threading.Thread(target=avvia_bot, daemon=True).start()
    web()
    
